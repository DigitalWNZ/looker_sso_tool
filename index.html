<!--


*****************************************************************
*****************************************************************
**
**
**		Hi!
**
**		This is a tool, not an example.
**		DO NOT send your embed secret to users' browsers
**
**		Really.
**
**		Don't.
**
**
*****************************************************************
*****************************************************************


-->
<html>
<head>
	<title>SSO Embed Constructor</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/json-editor/0.7.28/jsoneditor.min.js" integrity="sha256-51+oMmpgSgS4jV5/DcGKnDHIOL6Jeie2i7ka6sPQVro=" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.3/css/foundation.min.css" integrity="sha256-NTds7atVCDeolLUzbcl45lx4gJYO+hNXCaX1wC2HQHc=" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/2.2.0/sha1.js" integrity="sha256-+wcjkt38O0q7BEzMX2Ivt0V9AGhx2jhuMtcdp5zHnGM=" crossorigin="anonymous"></script>
<style>textarea{font-size:10pt !important;}</style>
<script>
	// Set the JSONEditor CSS theme and icon library globally
	JSONEditor.defaults.theme = 'foundation5';
	JSONEditor.defaults.iconlib = 'fontawesome4';
</script>
</head>
<body>
<div id="panel-toggle" style="height:2em;width:2em;position:fixed;left:-1px;bottom:-1px;z-index:20;text-align:center;background-color:#DDD;color:#333;border:1px solid #666;cursor:pointer;">
	<i class="fa fa-eye-slash"></i>
</div>
<div style="display:flex; justify-content: space-around">
	<div id="build-panel" style="flex-grow:1;min-width:480px;margin:0 25px">
		<form id="build-form">
			<div id="json-editor"></div>
			<div id="msg" style="white-space:pre-line;color:#333;background-color:#DDB"></div>
			<div style="text-align:right">
				<div style="display:inline-block;vertical-align:top;">
					<div><label for="embed-flag">Embed</label></div>
					<div><input id="embed-flag" type="checkbox" checked="checked" /></div>
				</div>
				<div  style="display:inline-block;vertical-align:top;margin: 0 2em;">
					<input type="submit" style="margin-left:auto;margin-right:auto;border:solid 1px black" value="Go" class="button" />
				</div>
			</div>
		</form>
	</div>
	<div style="flex-grow:1;min-width:480px;margin:0 25px">
		<h2>Tips</h2>
		<ul style="font-size:0.8em; font-family:serif; color:#333;">
			<li> This is for demo/understanding only. You should never make the embed secret available to a user's browser.</li>
			<li> Check the properties button for additional parameters you can configure</li>
			<li> The form state is persisted when you close this page (Use non-incognito mode)</li>
			<li> The force_logout_login parameter will cause the embed to either use your existing Looker session, or force a new one (thus logging you out), so use incognito mode to test if you are also logged into Looker</li>
			<li> Use the JSON button to copy the form state into another page (i.e. from non-incognito into an incognito tab)</li>
			<li> If you want to use the Embed URI Validator in Looker, embedding here will consume the nonce and cause the URL to be invalid. Uncheck the "Embed" checkbox at the bottom to not embed after building the URL.</li>
		</ul>
		<h2>Built URL</h2>
		<textarea style="width:100%;height:12em" readonly="readonly" id="url-display"></textarea>
		<h2>Embed Preview</h2>
		<iframe id="embed-iframe" style="width:100%;height:560px"></iframe>
	</div>
</div>
</body>
<script>
var pathSchema = {type:"string",required:true}
/* TODO write toString for this "Path Builder" schema
		{title:"Path",required:true,oneOf:[
		{title:"Manual path",type:"string"},
		{title:"Space",
				type:"object",
				options:{"no_additional_properties":true},
				properties:{
						"id":{title:"Space ID",type:"number"},
						"querystring":{
								type:"object",title:"Querystring parameters",
								options:{disable_properties:false,no_additional_properties:false},
								properties:{
										"embed_domain":{required:false,type:"string",pattern:"^https?://[-.a-zA-Z0-9]$"}
									}
							}	
					}
			},
		{title:"Look",
				type:"object",
				options:{"no_additional_properties":true},
				properties:{
						"id":{title:"Look ID",type:"number"},
						"querystring":{
								type:"object",title:"Querystring parameters",
								options:{disable_properties:false,no_additional_properties:false},
								properties:{
										"embed_domain":{required:false,type:"string",pattern:"^https?://[-.a-zA-Z0-9]$"}
									}
							}	
					}
			},
		{title:"UDD dashboard",
				type:"object",
				options:{"no_additional_properties":true},
				properties:{
						"id":{title:"Dashboard ID",type:"number"},
						"querystring":{
								type:"object",title:"Querystring parameters",
								options:{disable_properties:false,no_additional_properties:false},
								properties:{
										"embed_domain":{required:false,type:"string",pattern:"^https?://[-.a-zA-Z0-9]$"}
									}
							}	
					}
			},
		{title:"LookML dashboard",
				type:"object",
				format:"compact",
				options:{"no_additional_properties":true},
				properties:{
						"model":{title:"Model name",type:"string"},
						"dashboard":{title:"Dashboard name",type:"string"},
						"querystring":{
								type:"object",title:"Querystring parameters",
								options:{disable_properties:false,no_additional_properties:false},
								properties:{
										"embed_domain":{required:false,type:"string",pattern:"^https?://[-.a-zA-Z0-9]$"}
									}
							}	
					}
			},
		{title:"Explore",
				type:"object",
				properties:{
						"model":{title:"Model name",type:"string"},
						"explore":{title:"Explore name",type:"string"},
						"querystring":{
								type:"object",title:"Querystring parameters",
								options:{disable_properties:false,no_additional_properties:false},
								properties:{
										"embed_domain":{required:false,type:"string",pattern:"^https?://[-.a-zA-Z0-9]$"}
									}
							}	
					}
			}
	]} */
				
var definitions=[
		{sort:{ui:01,qs:00,hash:00}, id:"embed_secret", schema:{required:true}},
		{sort:{ui:02,qs:00,hash:01}, id:"host", schema:{required:true}, noJSON:true},
		{sort:{ui:03,qs:00,hash:02}, id:"embed_path", schema:pathSchema, noJSON:true,
				fn:(path=>"/login/embed/"+encodeURIComponent(path))
			},
		{sort:{ui:98,qs:11,hash:03}, id:"nonce",schema:{required:false},fn:(x=>x||nonce(16))},
		{sort:{ui:99,qs:12,hash:04}, id:"time",schema:{required:false},fn:(x=>x||parseInt(Date.now()/1000))},
		{sort:{ui:90,qs:13,hash:05}, id:"session_length", schema:{required:true,type:"number",minimum:1}},
		{sort:{ui:04,qs:14,hash:06}, id:"external_user_id", schema:{required:true}},
		{sort:{ui:05,qs:31,hash:00}, id:"first_name", schema:{required:true}},
		{sort:{ui:06,qs:32,hash:00}, id:"last_name", schema:{required:true}},
		{sort:{ui:07,qs:21,hash:07}, id:"permissions",
				schema:{type:"array",required:true,uniqueItems:true,items:{type:"string",enum:[
						"access_data",
						"see_looks",
						"see_user_dashboards",
						"see_lookml_dashboards",
						"explore",
						"create_table_calculations",
						"download_with_limit",
						"download_without_limit",
						"see_drill_overlay",
						"save_content",
						"embed_browse_spaces",
						"schedule_look_emails",
						"schedule_external_look_emails",
						"send_to_sftp",
						"send_to_s3",
						"send_outgoing_webhook",
						"see_sql" /* v4.10 */
						/* FYI - SSO does not allow all permissions. If you add unsupported permissions, they will fail  */
					]}}
			},
		{sort:{ui:08,qs:22,hash:08}, id:"models",schema:{required:true,pattern:"^[A-Za-z0-9_]+(,\\s*[A-Za-z0-9_]+)*$"},fn:(s)=>s.split(/,\s*/)},
		{sort:{ui:09,qs:23,hash:09}, id:"group_ids",schema:{required:false,pattern:"^$|^[0-9]+(,\\s*[0-9]+)*$"},fn:(s)=>(s==""?[]:s.split(/,\s*/).map(s=>parseInt(s)))},
		{sort:{ui:10,qs:24,hash:10}, id:"external_group_id",schema:{required:false},fn:x=>x||""},
		{sort:{ui:11,qs:25,hash:11}, id:"user_attributes",schema:{required:false,type:"array",format:"table",items:{type:"object",
					properties:{
							field:{type:"string"},
							value:{type:"string"}
						}}
				},
				fn:(a=>(a||[]).reduce(objByOf(["field"],"value"),{}))},
		{sort:{ui:12,qs:26,hash:12}, id:"access_filters",schema:{type:"array",required:false,format:"table",items:{type:"object",
				properties:{
						model:{type:"string"},
						field:{type:"string"},
						value:{type:"string"}
					}}
			},
			fn:(a=>(a||[]).reduce(objByOf(["model","field"],"value"),{}))},

		{sort:{ui:91,qs:41,hash:00}, id:"force_logout_login",schema:{type:"boolean",required:true,format:"checkbox"}}
	]
	//.map(d=>set(d,"schema",get(d,"schema")||{}))
	.map(d=>set(d,"schema.type",get(d,"schema.type")||(get(d,"schema.oneOf")?undefined:"string")))
	.map(d=>set(d,"schema.propertyOrder",get(d,"sort.ui")))
	.map(d=>set(d,"schema.title",autoLabel(d.id)))

var initialValue={
		"embed_path":"/embed/looks/1",
		"session_length":600,
		"external_user_id":"test-id-123",
		"first_name":"Testy",
		"last_name":"McTestFace",
		"permissions":["access_data","see_looks"],
		"force_logout_login":true
	}

var editorDef= {
		schema: {
				type:"object",
				title:"SSO Embed Demo",
				options:{"disable_edit_json":false,"disable_properties":false,"remove_empty_properties":true},
				properties:definitions
						.filter(d => d.sort.ui)
						.reduce(objByOf("id","schema"),{})
			},
		startval: tryLocalStorageGet("json-val",initialValue),
		//"required_by_default":true,
		"disable_collapse":true,
		"disable_properties":true,
		"display_required_only":true,
		"keep_oneof_values":true,
		"disable_edit_json":true
	}
var editor = new JSONEditor($("#json-editor")[0],editorDef);
editor.on('change',function() {
		localStorage.setItem("json-val",JSON.stringify(editor.getValue()))
	});
//grrrrrrr...... Chrome is doing something annoying...
//$("input").on("invalid",function(evt){
//		evt.preventDefault();//
//	})

$("#panel-toggle").click(function(){$("#build-panel").toggle()})

$("#url-display").focus(function(){
		// Highlight all on select
		// Solution per http://stackoverflow.com/a/24589806
		$(this).on("click.a keyup.a", function(e){
				$(this).off("click.a keyup.a").select();
			});
	});
$("#url-display").on("keypress",function(evt){
		if(evt.keyCode==13){
				$("#embed-iframe")[0].src=this.value
			}
	})

$("#build-form").on("submit",function(evt){
		evt.preventDefault();
		$("#msg").hide();
		var errs=editor.validate();
		if(errs.length){
				$("#msg")
				.text(errs.map(e=>e.path+": "+e.message).join("\n"))
				.show()
				return;
			}
		var editorValue=editor.getValue()
		var definitionValues=
				definitions
				.map(d=>({d:d,val:d.default || ""}))
				.map(({d,val})=>({d:d,val:
						editorValue[d.id]!==undefined && editorValue[d.id]!==""
								? editorValue[d.id]
								: val
					}))
				.map(({d,val})=>({d:d,val:
						d.fn?d.fn(val):val
					}))
				.map(({d,val})=>({d:d,val:
						d.noJSON?val:JSON.stringify(val)
					}))
		var valuesById=definitionValues.reduce(objByOf("d.id","val"),{})
		console.log("Values:",valuesById)
		//App specific logic
		var hashContent=definitionValues
				.filter(dv=>dv.d.sort.hash)
				.sort(sorter("d.sort.hash"))
				.map(dv=>dv.val)
				.join("\n")
			;
		var shaObj;
		var signature=(
				// Did you read the note at the top of the file???
				shaObj=new jsSHA("SHA-1", "TEXT"),
				shaObj.setHMACKey(editorValue.embed_secret,"TEXT"),
				//Based on the format of the secret, you would think Hex...
				shaObj.update(hashContent),
				shaObj.getHMAC("B64")
			);
		console.log("Signature:",signature)
		var url=("https://"
				+ valuesById.host
				+ valuesById.embed_path
				+ "?"
				+ definitionValues
						.filter(dv=>dv.d.sort.qs)
						.sort(sorter("d.sort.qs")) //Not required, but nice for consistency
						.map(dv=>encodeURIComponent(dv.d.id)+"="+encodeURIComponent(dv.val))
						.join("&")
				+ "&signature=" + encodeURIComponent(signature)
			);
		//console.log("Url:",url)
		$("#url-display").val(url)
		if($("#embed-flag")[0].checked){
				$("#embed-iframe")[0].src=url
			}
	})

//Just functions below

function set(obj,path,val){
		if(path.split){path=path.split('.')}
		var head=path[0];
		if(path.length==1){
				obj[head]=val
			}else{
				obj[head]=obj[head]||{};
				set(obj[head],path.slice(1),val)
			}
		return obj;
	}
function get(obj,path){
		if(path.split){path=path.split('.')}
		var head=path[0];
		if(path.length==1){
				return obj && obj[head];
			}else{
				return get(obj[head],path.slice(1))
			}
	}

function objByOf(byKeys,ofKey){
		byKeys=(byKeys instanceof Array ? byKeys : [byKeys])
		return function(accum,x,i){
				return set(accum,byKeys.map(k=>get(x,k)),ofKey?get(x,ofKey):x)
			}
	}
function sorter(path){
		return function(a,b){
				return get(a,path)-get(b,path)
			}
	}

function nonce(len) {
		var text = "";
		var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
		for (var i = 0; i < len; i++){
				text += possible.charAt(Math.floor(Math.random() * possible.length));
			}
		return text;
	}
function autoLabel(name){
		return name.replace(/(^|_)([a-z])/g,s=>s.toUpperCase()).replace(/_/g," ")
	}
	
function pathBuilderObjectToString(obj){
	
	
	
	
	}
function tryLocalStorageGet(key,defaultVal){
		try{
				return JSON.parse(localStorage.getItem(key))||defaultVal
			}catch(e){
				return defaultVal
			}
	}
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-96247573-1', 'auto');
  ga('set', 'checkProtocolTask', null); // Disable file protocol checking.
  ga('set', 'checkStorageTask', null); // Disable cookie storage checking.
  ga('set', 'historyImportTask', null); // Disable history checking (requires reading from cookies).
  ga('send', 'pageview');

</script>
</html>
