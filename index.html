<!--


*****************************************************************
*****************************************************************
**
**
**		Hi!
**
**		This is a tool, not an example.
**		DO NOT send your embed secret to users' browsers
**
**		Really.
**
**		Don't.
**
**
*****************************************************************
*****************************************************************


-->
<html>
<head>
	<title>SSO Embed Constructor</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" integrity="sha256-KM512VNnjElC30ehFwehXjx1YCHPiQkOPmqnrWtpccM=" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" integrity="sha256-rByPlHULObEjJ6XQxW/flG2r+22R5dKiAoef+aXWfik=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/themes/base/theme.min.css" integrity="sha256-vbQBfuBaoHN4AihkaCf4ba2w9vDrnpmiLahbYINNaa8=" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/json-editor/0.7.28/jsoneditor.min.js" integrity="sha256-51+oMmpgSgS4jV5/DcGKnDHIOL6Jeie2i7ka6sPQVro=" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.3/css/foundation.min.css" integrity="sha256-NTds7atVCDeolLUzbcl45lx4gJYO+hNXCaX1wC2HQHc=" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/2.2.0/sha1.js" integrity="sha256-+wcjkt38O0q7BEzMX2Ivt0V9AGhx2jhuMtcdp5zHnGM=" crossorigin="anonymous"></script>
<style>textarea{font-size:10pt !important;}</style>
<script>
	// Set the JSONEditor CSS theme and icon library globally
	JSONEditor.defaults.theme = 'foundation5';
	JSONEditor.defaults.iconlib = 'fontawesome4';
</script>
</head>
<body>
	<div style="display:flex;height:1.5em;">
		<input type="button" style="width:10vw;height:1.5em" value="Build..." id="start"/>
		<input type="text" style="width:90vw;height:1.5em" readonly="readonly" id="url-display"/>
	</div>
	<iframe id="embed-iframe" style="width:100vw;height:90vh"></iframe>
	<div id="dialog" style="display:none">
		<form id="build-form">
			<div id="json-editor"></div>
			<div id="msg" style="white-space:pre-line;color:#333;background-color:#ddd"></div>
			<div style="text-align:right">
				<div style="display:inline-block;vertical-align:top;">
					<div><label for="embed-flag">Embed</label></div>
					<div><input id="embed-flag" type="checkbox" checked="checked" /></div>
				</div>
				<div  style="display:inline-block;vertical-align:top;margin: 0 2em;">
					<input type="submit" style="margin-left:auto;margin-right:auto;border:solid 1px black" value="Go" class="button" />
				</div>
			</div>
		</form>
	</div>
</body>
<script>
var definitions=[
		{sort:{ui:01,qs:00,hash:00}, id:"embed_secret"},
		{sort:{ui:02,qs:00,hash:01}, id:"host",noJSON:true},
		{sort:{ui:03,qs:00,hash:02}, id:"embed_path",
				fn:(path=>"/login/embed/"+encodeURIComponent(path)),
				noJSON:true
			},
		{sort:{ui:00,qs:11,hash:11}, id:"nonce",fn:(()=>""||nonce(16))},
		{sort:{ui:00,qs:12,hash:12}, id:"time",fn:(()=>0||parseInt(Date.now()/1000)),qs:"time"},
		{sort:{ui:11,qs:13,hash:13}, id:"session_length",schema:{type:"number"}},
		{sort:{ui:04,qs:14,hash:14}, id:"external_user_id"},
		{sort:{ui:05,qs:31,hash:00}, id:"first_name"},
		{sort:{ui:06,qs:32,hash:00}, id:"last_name"},
		{sort:{ui:07,qs:21,hash:21}, id:"permissions",
				schema:{type:"array",uniqueItems:true,items:{type:"string",enum:[
						"access_data",
						"see_looks",
						"see_user_dashboards",
						"see_lookml_dashboards",
						"explore",
						"create_table_calculations",
						"download_with_limit",
						"download_without_limit",
						"see_drill_overlay",
						"save_content",
						"embed_browse_spaces",
						"schedule_look_emails",
						"schedule_external_look_emails",
						"send_to_sftp",
						"send_to_s3",
						"send_outgoing_webhook",
						"see_sql" /* v4.10 */
						/* FYI - SSO does not allow all permissions. If you add unsupported permissions, they will fail silently */
					]}}
			},
		{sort:{ui:08,qs:22,hash:22}, id:"models",schema:{pattern:"^[A-Za-z0-9_]+(,\\s*[A-Za-z0-9_]+)*$"},fn:(s)=>s.split(/,\s*/)},
		{sort:{ui:09,qs:23,hash:23}, id:"group_ids",schema:{pattern:"^$|^[0-9]+(,\\s*[0-9]+)*$"},fn:(s)=>(s==""?[]:s.split(/,\s*/).map(s=>parseInt(s)))},
		{sort:{ui:11,qs:24,hash:24}, id:"external_group_id"},
		{sort:{ui:10,qs:25,hash:25}, id:"access_filters",schema:{type:"array",format:"table",items:{type:"object",
				properties:{
						model:{type:"string"},
						field:{type:"string"},
						value:{type:"string"}
					}}
			},
			fn:(a=>a.reduce(objByOf(["model","field"],"value"),{}))},
		{sort:{ui:12,qs:41,hash:00}, id:"force_logout_login",schema:{type:"boolean",format:"checkbox"}}
	]
	.map(d=>set(d,"schema",get(d,"schema")||{}))
	.map(d=>set(d,"schema.type",get(d,"schema.type")||"string"))
	.map(d=>set(d,"schema.propertyOrder",get(d,"sort.ui")))
	.map(d=>set(d,"schema.title",autoLabel(d.id)))
	
var editorDef= {
		schema: {
				type:"object",
				title:" ",
				properties:definitions
						.filter(d => d.sort.ui)
						.reduce(objByOf("id","schema"),{})
			},
		startval: JSON.parse(localStorage.getItem("json-val"))
		,"required_by_default":true
		,"disable_collapse":true
		//,"no_additional_properties":false
	}
var editor = new JSONEditor($("#json-editor")[0],editorDef);
editor.on('change',function() {
		localStorage.setItem("json-val",JSON.stringify(editor.getValue()))
	});
//grrrrrrr...... Chrome is doing something annoying, can't seem to use patterns...
//$("input").on("invalid",function(evt){
//		evt.preventDefault();//
//	})

$("#start").click(loadModal)
$(document).ready(loadModal)


$("#url-display").focus(function(){
		// Highlight all on select
		// Solution per http://stackoverflow.com/a/24589806
		$(this).on("click.a keyup.a", function(e){
				$(this).off("click.a keyup.a").select();
			});
	});
$("#url-display").on("keypress",function(evt){
		if(evt.keyCode==13){
				$("#embed-iframe")[0].src=this.value
			}
	})

function loadModal(evt){
		evt.preventDefault && evt.preventDefault();
		var dialog=$("#dialog").dialog({
				title:"SSO Embed Construction",
				modal:true,
				width:1020,
				height:1040
			});

		$("#build-form").off()
		$("#build-form").on("submit",function(evt){
				evt.preventDefault();
				$("#msg").hide();
				var errs=editor.validate();
				if(errs.length){
						$("#msg")
						.text(errs.map(e=>e.path+": "+e.message).join("\n"))
						.show()
						return;
					}
				var editorValue=editor.getValue()
				//window.editorValue=editorValue;
				var definitionValues=
						definitions
						.map(d=>({d:d,val:d.default || ""}))
						.map(({d,val})=>({d:d,val:
								editorValue[d.id]!==undefined && editorValue[d.id]!==""
										? editorValue[d.id]
										: val
							}))
						.map(({d,val})=>({d:d,val:
								d.fn?d.fn(val):val
							}))
						.map(({d,val})=>({d:d,val:
								d.noJSON?val:JSON.stringify(val)
							}))
				var valuesById=definitionValues.reduce(objByOf("d.id","val"),{})
				console.log("Values:",valuesById)
				//App specific logic
				var hashContent=definitionValues
						.filter(dv=>dv.d.sort.hash)
						.sort(sorter("d.sort.hash"))
						.map(dv=>dv.val)
						.join("\n")
					;
				var shaObj;
				var signature=(
						// Did you read the note at the top of the file???
						shaObj=new jsSHA("SHA-1", "TEXT"),
						shaObj.setHMACKey(editorValue.embed_secret,"TEXT"),
						//Based on the format of the secret, you would think Hex...
						shaObj.update(hashContent),
						shaObj.getHMAC("B64")
					);
				console.log("Signature:",signature)
				var url=("https://"
						+ valuesById.host
						+ valuesById.embed_path
						+ "?"
						+ definitionValues
								.filter(dv=>dv.d.sort.qs)
								.sort(sorter("d.sort.qs"))
								.map(dv=>encodeURIComponent(dv.d.id)+"="+encodeURIComponent(dv.val))
								.join("&")
						+ "&signature=" + encodeURIComponent(signature)
					);
				//console.log("Url:",url)
				$("#url-display").val(url)
				if($("#embed-flag")[0].checked){
						$("#embed-iframe")[0].src=url
					}
				$("#dialog").dialog("close")
			})
	}

function set(obj,path,val){
		if(path.split){path=path.split('.')}
		var head=path[0];
		if(path.length==1){
				obj[head]=val
			}else{
				obj[head]=obj[head]||{};
				set(obj[head],path.slice(1),val)
			}
		return obj;
	}
function get(obj,path){
		if(path.split){path=path.split('.')}
		var head=path[0];
		if(path.length==1){
				return obj && obj[head];
			}else{
				return get(obj[head],path.slice(1))
			}
	}

function objByOf(byKeys,ofKey){
		byKeys=(byKeys instanceof Array ? byKeys : [byKeys])
		return function(accum,x,i){
				return set(accum,byKeys.map(k=>get(x,k)),ofKey?get(x,ofKey):x)
			}
	}
function sorter(path){
		return function(a,b){
				return get(a,path)-get(b,path)
			}
	}

function nonce(len) {
		var text = "";
		var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
		for (var i = 0; i < len; i++){
				text += possible.charAt(Math.floor(Math.random() * possible.length));
			}
		return text;
	}
function autoLabel(name){
		return name.replace(/(^|_)([a-z])/g,s=>s.toUpperCase()).replace(/_/g," ")
	}
</script>
</html>
